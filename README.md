# mmaconv

mmaconv provides a library and a set of command to help the extraction of raw MMA data and their conversion into calibrated temperatures and acceleration.

### Commands

#### mmaconv

mmaconv command convert the raw binary data found into a directory/file into their calibrated values (temperatures and acceleration).

the output is a csv file with the following columns:

* time
* upi
* sequence (milbus sequence counter)
* vmu-sequence
* Tx, Ty, Tz (degree celsius)
* Ax, Ay, Az (micro gravity)

files generated will be written when the [-d] option is given a sub directory of the year of the acquisition and the filename will have the following structure: <doy acq>.<doy gen>.<ext>

options:

* [-a]: write all fields from a measurement in the output
* [-b]: number of measurements accepted by input files in order to set a timestamp (default 1512)
* [-c]: use the conversion table given in a configuration file (toml format)
* [-d]: directory where files should be written
* [-f]: write all values from one block on the same line instead of multiple line
* [-i]: format time with a ISO format
* [-j]: adjust the time for each row in the output otherwise you the acquisition time found in the input files
* [-r]: walk recursively throught all files for the given directory
* [-t]: use the given duration as time between two row in the output
* [-x]: configuration file with list of period during which activities took place (see below for more info)
* [-z]: compress output file

```bash
$ mmaconv -j -r -d converted -z tmp/mma

$ mmaconv -j -i -r tmp/mma
```

#### mmaextract

mmaextract extracts the data from a raw binary file and output the results to stdout.

options:

* [-r]: configuration file with list of period during which activities took place (see below for more info)
* [-q]: suppress output
* [-d]: remove duplicate records

```bash
mmaextract tmp/mma/0051_SCIENCE_3_000000_20210529_101010.dat
9,4086,10073,10286,9930,-437,-243,-52,-369,-299,-134,-315,-299,-109,-336,-283,-20,-355,-293,-39,-373,-276,-19,-422,-286,-28,-457,-219,-68,-450,-135,-133
9,4095,10073,10286,9932,-436,-131,-165,-464,-156,-161,-437,-294,-96,-376,-351,-73,-326,-334,-36,-355,-284,-25,-361,-250,-1,-393,-220,-33,-412,-175,-60
```

#### mmacheck

mmacheck output a summary where it detects an inconsistency between two lines in a file given in argument. The given file i ssupposed to be one generated by the mmaconv command.

```bash
$ mmacheck mma-128.csv
217225: 2018-09-18 11:53:49.954940 - 2018-09-18 11:53:49.952344 => diff:   -2.596ms (prev:  56167, curr:  56176, delta:      9)
218728: 2018-09-18 11:53:50.953676 - 2018-09-18 11:53:50.952872 => diff:     -804µs (prev:  57670, curr:  57679, delta:      9)
220222: 2018-09-18 11:53:51.948205 - 2018-09-18 11:53:51.952581 => diff:    4.376ms (prev:  59164, curr:  59173, delta:      9)
221725: 2018-09-18 11:53:52.953913 - 2018-09-18 11:53:52.951989 => diff:   -1.924ms (prev:  60667, curr:  60676, delta:      9)
223228: 2018-09-18 11:53:53.953322 - 2018-09-18 11:53:53.951245 => diff:   -2.077ms (prev:  62170, curr:  62179, delta:      9)
224722: 2018-09-18 11:53:54.946577 - 2018-09-18 11:53:54.951267 => diff:     4.69ms (prev:  63664, curr:  63673, delta:      9)
226225: 2018-09-18 11:53:55.952599 - 2018-09-18 11:53:55.952226 => diff:     -373µs (prev:  65167, curr:  65176, delta:      9)
```

#### mmastats

mmastats command walks throught the list of files and directories and output the frequency of number of blocks per files/directories

options:

* [-r]: configuration file with list of period during which activities took place (see below for more info)
* [-x]: list of directories that should be excluded from traversal (only last part of path can be given)
* [-s]: produces only a summary of the results
* [-v]: when given with the [s] otpion, it keeps the output for the intermediate results

```bash
$ mmastats {playback,realtime}/51/*/*
doy 112:  396:     24 (vmu-seq:  16404)
         1485:    100 (vmu-seq:  16217)
         1494:   7639 (vmu-seq:  16083)
         1503:  14113 (vmu-seq:  16081)
         1512:    380 (vmu-seq:  16099)
         1521:      1 (vmu-seq:  30468)
         1530:      1 (vmu-seq:  26615)
         1584:      1 (vmu-seq:  26612)
         1764:     23 (vmu-seq:  16407)
         1773:      1 (vmu-seq:  34774)
         1980:     50 (vmu-seq:  16405)

$ mmastats -s {playback,realtime}/51/*/*
summary  396:     24 (vmu-seq:      0)
        1485:    176 (vmu-seq:      0)
        1494:  13334 (vmu-seq:      0)
        1503:  24673 (vmu-seq:      0)
        1512:    684 (vmu-seq:      0)
        1521:      1 (vmu-seq:      0)
        1530:      1 (vmu-seq:      0)
        1584:      1 (vmu-seq:      0)
        1764:     23 (vmu-seq:      0)
        1773:      2 (vmu-seq:      0)
        1980:     52 (vmu-seq:      0)
```

#### mmalisten

mmalisten subscribes to the PP multicast streams generated by hadock in order to process the MMA in realtime (near-realtime).

mmalisten uses a single configuration (toml) file as only input argument. The configuration file has the following options:

* addr: multicast address where mmalisten has to subscribe
* in-dir: directory of the hadock archive where mmalisten can find the file given in the reference of the PP
* out-dir: directory where the converted files should be stored
* adjust-time: adjust the time for each row in the output otherwise you the acquisition time found in the input files
* iso-format: format time as ISO format
* compress: compress output file
* interval: string to give the duration between two row in the output (same as [t] option of mmaconv)

```bash
$ mmalisten config.toml
```

### range configuration file

some of the commands accept a configuration files with a list of period during which activities where performed. The format of this configuration is given in this section.

Important to repeat, this configuration should hold range when activities took place.

The config file should be composed of at least one [[range]] section. Each of these sections should have two options:

* starts: the start date of the interval
* ends: the end date of the interval

if one of this two options missing, the interval is discarded. Same if starts is after ends.

sample

```toml
[[range]]
starts = 2021-05-01
ends   = 2021-06-11T23:59:59Z

[[range]]
starts = 2021-07-01
ends   = 2022-01-01
```
